<!DOCTYPE html>
<html>
  <head>
    <title>Crash Game Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2"></script>

    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      canvas {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div
      style="
        height: 600px;
        overflow-y: scroll;
        border: 1px solid #ccc;
        margin-bottom: 20px;
      "
      id="tableContainer"
    >
      <table
        id="outputTable"
        border="1"
        cellspacing="0"
        cellpadding="5"
        style="font-family: monospace; width: 100%; max-width: 100%"
      >
        <thead>
          <tr>
            <th>Date</th>
            <th>Avg</th>
            <th>Count</th>
            <th>Baga</th>
            <th>ih</th>
            <th>Score</th>
            <th>Diff</th>
            <th>Mark</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h2>Crash Multipliers Chart</h2>
    <canvas id="crashChart"></canvas>

    <!-- Put your script AFTER the canvas -->
    <script>
      const tbody = document.querySelector("#outputTable tbody");
      const container = document.getElementById("tableContainer");
      const MAX_ROWS = 2000;
      const socket = io();

      // --- Chart.js setup ---
      const ctx = document.getElementById("crashChart").getContext("2d");
      const crashChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Crash Multiplier (f)",
              data: [],
              borderColor: "rgba(75,192,192,1)",
              backgroundColor: "rgba(75,192,192,0.2)",
              borderWidth: 2,
              fill: true,
              pointRadius: 0,
              tension: 0.25,
            },
          ],
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: { title: { display: true, text: "Time" } },
            y: {
              title: { display: true, text: "Multiplier" },
              beginAtZero: true,
              suggestedMax: 35, // optional, since your data is 1â€“35
            },
          },
          plugins: {
            annotation: {
              annotations: {
                lineAt2: {
                  type: "line",
                  yMin: 2,
                  yMax: 2,
                  borderColor: "red",
                  borderWidth: 2,
                  label: {
                    enabled: true,
                    content: "Reference 2",
                    position: "start",
                  },
                },
              },
            },
          },
        },
        plugins: [Chart.registry.getPlugin("annotation")],
      });

      function createRow(data) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.dateStr}</td>
          <td>${data.avg.toFixed(2)}</td>
          <td>${data.count}</td>
          <td>${data.baga}</td>
          <td>${data.ih}</td>
          <td>${data.f}</td>
          <td>${data.diff}</td>
          <td>${data.temdeg}</td>
        `;
        return tr;
      }

      socket.on("crash-history", (history) => {
        tbody.innerHTML = "";
        crashChart.data.labels = [];
        crashChart.data.datasets[0].data = [];

        history.forEach((data) => {
          tbody.appendChild(createRow(data));
          crashChart.data.labels.push(data.dateStr);
          crashChart.data.datasets[0].data.push(Number(data.f));
        });

        crashChart.update();
        container.scrollTop = container.scrollHeight;
      });

      socket.on("crash-data", (data) => {
        tbody.appendChild(createRow(data));

        while (tbody.rows.length > MAX_ROWS) {
          tbody.removeChild(tbody.firstChild);
        }

        crashChart.data.labels.push(data.dateStr);
        crashChart.data.datasets[0].data.push(Number(data.f));

        if (crashChart.data.labels.length > MAX_ROWS) {
          crashChart.data.labels.shift();
          crashChart.data.datasets[0].data.shift();
        }

        crashChart.update("none");
        container.scrollTop = container.scrollHeight;
      });
    </script>
  </body>
</html>
